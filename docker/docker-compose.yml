services:
  hidego-tgbot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: hidego-tgbot
    
    #* Run as host user to avoid ownership issues
    user: "${USER_UID:-1000}:${USER_GID:-1000}"
    
    #* Enable TTY and interactive mode for password input
    tty: true
    stdin_open: true
    
    #* Environment variables from .env file
    env_file:
      - ../.env
    
    #* Port mapping - use FASTAPI_PORT from .env
    ports:
      - "${FASTAPI_PORT:-13360}:${FASTAPI_PORT:-13360}"
    
    #* Volume mounts for persistent data
    volumes:
      - ../data:/app/data
      - ../logs:/app/logs
      - ../secret:/app/secret
      - ../diff:/app/diff
      - ../.env:/app/.env:ro
    
    #* Network configuration
    networks:
      - hidego-network
    
    #* Security options
    security_opt:
      - no-new-privileges:true
    
    #* Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       memory: 1G
    #       cpus: '1.0'
    #     reservations:
    #       memory: 512M
    #       cpus: '0.5'

  cloudflared:
    build:
      context: cloudflared
      dockerfile: Dockerfile
    container_name: hidego-cloudflared
    
    #* Restart policy
    restart: unless-stopped
    
    #* Volume mounts for Cloudflare configuration
    volumes:
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      - ./cloudflared/credentials.json:/etc/cloudflared/credentials.json:ro
    
    #* Network configuration - must be on same network as bot
    networks:
      - hidego-network
    
    #* Depends on bot service
    depends_on:
      - hidego-tgbot
    
    #* Security options
    security_opt:
      - no-new-privileges:true

networks:
  hidego-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1